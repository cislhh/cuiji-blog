---
slug: typescript-advanced-type-system-engineering
title: TypeScripté«˜çº§ç±»å‹ç³»ç»Ÿä¸å·¥ç¨‹åŒ–å®è·µ
date: 2025-04-12
authors: [cuiji]
tags: [typescript, advanced-types, generics, engineering]
keywords: [TypeScript, é«˜çº§ç±»å‹, æ³›å‹, ç±»å‹ä½“æ“, å·¥ç¨‹åŒ–, ç±»å‹å®‰å…¨]
---

TypeScript ä¸ä»…ä»…æ˜¯ä¸º JavaScript æ·»åŠ ç±»å‹æ³¨è§£ï¼Œå®ƒæä¾›äº†ä¸€å¥—å®Œæ•´çš„ç±»å‹ç³»ç»Ÿï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘æ—¶æ•è·é”™è¯¯ï¼Œæé«˜ä»£ç è´¨é‡å’Œå¼€å‘æ•ˆç‡ã€‚ä½†å¾ˆå¤šå¼€å‘è€…åªåœç•™åœ¨åŸºç¡€çš„ç±»å‹æ³¨è§£é˜¶æ®µï¼Œæ²¡æœ‰å……åˆ†åˆ©ç”¨ TypeScript çš„é«˜çº§ç‰¹æ€§ã€‚

æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ TypeScript çš„é«˜çº§ç±»å‹ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ³›å‹ã€æ¡ä»¶ç±»å‹ã€æ˜ å°„ç±»å‹ç­‰ï¼Œä»¥åŠå¦‚ä½•åœ¨å®é™…é¡¹ç›®ä¸­åº”ç”¨è¿™äº›ç‰¹æ€§æ¥æ„å»ºç±»å‹å®‰å…¨çš„åº”ç”¨ç¨‹åºã€‚

---

## ä¸€ã€æ³›å‹ï¼šç±»å‹å‚æ•°åŒ–çš„è‰ºæœ¯

> ğŸ¯ æ ¸å¿ƒç†å¿µï¼šæ³›å‹è®©æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¯å¤ç”¨çš„ç»„ä»¶ï¼ŒåŒæ—¶ä¿æŒç±»å‹å®‰å…¨ã€‚

### åŸºç¡€æ³›å‹

```typescript
// åŸºç¡€æ³›å‹å‡½æ•°
function identity<T>(arg: T): T {
  return arg
}

// ä½¿ç”¨æ³›å‹
const stringResult = identity<string>('hello') // ç±»å‹: string
const numberResult = identity<number>(42) // ç±»å‹: number

// ç±»å‹æ¨æ–­
const inferred = identity('hello') // TypeScript è‡ªåŠ¨æ¨æ–­ä¸º string
```

### æ³›å‹æ¥å£

```typescript
// æ³›å‹æ¥å£
interface ApiResponse<T> {
  data: T
  status: number
  message: string
}

// ä½¿ç”¨æ³›å‹æ¥å£
interface User {
  id: number
  name: string
  email: string
}

interface Product {
  id: number
  title: string
  price: number
}

// ç±»å‹åŒ–çš„ API å“åº”
const userResponse: ApiResponse<User> = {
  data: { id: 1, name: 'å¼ ä¸‰', email: 'zhangsan@example.com' },
  status: 200,
  message: 'success',
}

const productResponse: ApiResponse<Product> = {
  data: { id: 1, title: 'iPhone', price: 5999 },
  status: 200,
  message: 'success',
}
```

### æ³›å‹çº¦æŸ

```typescript
// æ³›å‹çº¦æŸï¼šé™åˆ¶æ³›å‹å‚æ•°å¿…é¡»å…·æœ‰æŸäº›å±æ€§
interface Lengthwise {
  length: number
}

function logLength<T extends Lengthwise>(arg: T): T {
  console.log(arg.length)
  return arg
}

// ä½¿ç”¨çº¦æŸ
logLength('hello') // å­—ç¬¦ä¸²æœ‰ length å±æ€§
logLength([1, 2, 3]) // æ•°ç»„æœ‰ length å±æ€§
// logLength(123); // é”™è¯¯ï¼šæ•°å­—æ²¡æœ‰ length å±æ€§

// æ›´å¤æ‚çš„çº¦æŸ
function getProperty<T, K extends keyof T>(obj: T, key: K): T[K] {
  return obj[key]
}

const user = { name: 'å¼ ä¸‰', age: 25, email: 'zhangsan@example.com' }
const name = getProperty(user, 'name') // ç±»å‹: string
const age = getProperty(user, 'age') // ç±»å‹: number
// const invalid = getProperty(user, "invalid"); // é”™è¯¯ï¼šå±æ€§ä¸å­˜åœ¨
```

---

## äºŒã€æ¡ä»¶ç±»å‹ï¼šç±»å‹çº§åˆ«çš„æ¡ä»¶åˆ¤æ–­

> ğŸ§  æ ¸å¿ƒç†å¿µï¼šæ¡ä»¶ç±»å‹è®©æˆ‘ä»¬å¯ä»¥æ ¹æ®å…¶ä»–ç±»å‹æ¥åŠ¨æ€é€‰æ‹©ç±»å‹ã€‚

### åŸºç¡€æ¡ä»¶ç±»å‹

```typescript
// åŸºç¡€æ¡ä»¶ç±»å‹è¯­æ³•
type IsString<T> = T extends string ? true : false

// ä½¿ç”¨æ¡ä»¶ç±»å‹
type Test1 = IsString<string> // true
type Test2 = IsString<number> // false

// æ›´å®ç”¨çš„ä¾‹å­ï¼šæå–æ•°ç»„å…ƒç´ ç±»å‹
type ArrayElement<T> = T extends (infer U)[] ? U : never

type StringArray = string[]
type ElementType = ArrayElement<StringArray> // string

// æå–å‡½æ•°è¿”å›ç±»å‹
type ReturnType<T> = T extends (...args: any[]) => infer R ? R : never

function getUser(): { id: number; name: string } {
  return { id: 1, name: 'å¼ ä¸‰' }
}

type UserType = ReturnType<typeof getUser> // { id: number; name: string }
```

### åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹

```typescript
// åˆ†å¸ƒå¼æ¡ä»¶ç±»å‹ï¼šå½“æ¡ä»¶ç±»å‹ä½œç”¨äºè”åˆç±»å‹æ—¶
type ToArray<T> = T extends any ? T[] : never

type StringOrNumber = ToArray<string | number> // string[] | number[]

// è¿‡æ»¤è”åˆç±»å‹
type Filter<T, U> = T extends U ? T : never

type AllowedTypes = string | number | boolean
type StringOnly = Filter<AllowedTypes, string> // string

// æå–éç©ºç±»å‹
type NonNullable<T> = T extends null | undefined ? never : T

type MaybeString = string | null | undefined
type DefiniteString = NonNullable<MaybeString> // string
```

### é€’å½’æ¡ä»¶ç±»å‹

```typescript
// é€’å½’æ¡ä»¶ç±»å‹ï¼šå¤„ç†åµŒå¥—ç»“æ„
type DeepReadonly<T> = {
  readonly [P in keyof T]: T[P] extends object ? DeepReadonly<T[P]> : T[P]
}

interface User {
  id: number
  name: string
  profile: {
    avatar: string
    settings: {
      theme: string
      notifications: boolean
    }
  }
}

type ReadonlyUser = DeepReadonly<User>
// ç»“æœï¼šæ‰€æœ‰å±æ€§éƒ½å˜ä¸º readonlyï¼ŒåŒ…æ‹¬åµŒå¥—å¯¹è±¡

// æ·±åº¦å¯é€‰
type DeepPartial<T> = {
  [P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : T[P]
}

type PartialUser = DeepPartial<User>
// ç»“æœï¼šæ‰€æœ‰å±æ€§éƒ½å˜ä¸ºå¯é€‰ï¼ŒåŒ…æ‹¬åµŒå¥—å¯¹è±¡
```

---

## ä¸‰ã€æ˜ å°„ç±»å‹ï¼šæ‰¹é‡è½¬æ¢ç±»å‹

> ğŸ”„ æ ¸å¿ƒç†å¿µï¼šæ˜ å°„ç±»å‹è®©æˆ‘ä»¬å¯ä»¥åŸºäºç°æœ‰ç±»å‹åˆ›å»ºæ–°ç±»å‹ã€‚

### åŸºç¡€æ˜ å°„ç±»å‹

```typescript
// åŸºç¡€æ˜ å°„ç±»å‹è¯­æ³•
type Partial<T> = {
  [P in keyof T]?: T[P]
}

type Required<T> = {
  [P in keyof T]-?: T[P]
}

type Readonly<T> = {
  readonly [P in keyof T]: T[P]
}

// ä½¿ç”¨æ˜ å°„ç±»å‹
interface User {
  id: number
  name: string
  email: string
}

type PartialUser = Partial<User> // æ‰€æœ‰å±æ€§å¯é€‰
type RequiredUser = Required<User> // æ‰€æœ‰å±æ€§å¿…éœ€
type ReadonlyUser = Readonly<User> // æ‰€æœ‰å±æ€§åªè¯»
```

### é«˜çº§æ˜ å°„ç±»å‹

```typescript
// é”®é‡æ˜ å°„
type Getters<T> = {
  [K in keyof T as `get${Capitalize<string & K>}`]: () => T[K]
}

interface User {
  name: string
  age: number
}

type UserGetters = Getters<User>
// ç»“æœï¼š{ getName: () => string; getAge: () => number; }

// è¿‡æ»¤å±æ€§
type PickByType<T, U> = {
  [K in keyof T as T[K] extends U ? K : never]: T[K]
}

interface MixedObject {
  name: string
  age: number
  isActive: boolean
  createdAt: Date
}

type StringProps = PickByType<MixedObject, string> // { name: string }
type NumberProps = PickByType<MixedObject, number> // { age: number }

// æ¡ä»¶é”®é‡æ˜ å°„
type EventHandlers<T> = {
  [K in keyof T as `on${Capitalize<string & K>}`]: (value: T[K]) => void
}

interface FormData {
  username: string
  email: string
  password: string
}

type FormEventHandlers = EventHandlers<FormData>
// ç»“æœï¼š{ onUsername: (value: string) => void; onEmail: (value: string) => void; onPassword: (value: string) => void; }
```

---

## å››ã€æ¨¡æ¿å­—é¢é‡ç±»å‹ï¼šå­—ç¬¦ä¸²ç±»å‹æ“ä½œ

> ğŸ“ æ ¸å¿ƒç†å¿µï¼šæ¨¡æ¿å­—é¢é‡ç±»å‹è®©æˆ‘ä»¬å¯ä»¥åœ¨ç±»å‹çº§åˆ«æ“ä½œå­—ç¬¦ä¸²ã€‚

### åŸºç¡€æ¨¡æ¿å­—é¢é‡ç±»å‹

```typescript
// åŸºç¡€æ¨¡æ¿å­—é¢é‡ç±»å‹
type Greeting = `Hello, ${string}!`

const validGreeting: Greeting = 'Hello, World!' // æ­£ç¡®
const invalidGreeting: Greeting = 'Hi, World!' // é”™è¯¯

// æ›´å¤æ‚çš„ä¾‹å­
type EventName<T extends string> = `on${Capitalize<T>}`

type ClickEvent = EventName<'click'> // "onClick"
type SubmitEvent = EventName<'submit'> // "onSubmit"

// è”åˆç±»å‹æ¨¡æ¿
type SupportedEvents = 'click' | 'submit' | 'change'
type EventHandlers = EventName<SupportedEvents> // "onClick" | "onSubmit" | "onChange"
```

### é«˜çº§æ¨¡æ¿å­—é¢é‡ç±»å‹

```typescript
// å­—ç¬¦ä¸²åˆ†å‰²
type Split<S extends string, D extends string> = string extends S
  ? string[]
  : S extends ''
    ? []
    : S extends `${infer T}${D}${infer U}`
      ? [T, ...Split<U, D>]
      : [S]

type PathParts = Split<'user/profile/settings', '/'> // ["user", "profile", "settings"]

// å­—ç¬¦ä¸²æ›¿æ¢
type Replace<
  S extends string,
  From extends string,
  To extends string,
> = S extends `${infer L}${From}${infer R}` ? `${L}${To}${R}` : S

type UpdatedPath = Replace<'user/profile', 'profile', 'settings'> // "user/settings"

// å­—ç¬¦ä¸²é•¿åº¦
type Length<S extends string> = Split<S, ''>['length']

type NameLength = Length<'TypeScript'> // 10
```

---

## äº”ã€ç±»å‹ä½“æ“ï¼šå¤æ‚ç±»å‹æ“ä½œ

> ğŸ‹ï¸ æ ¸å¿ƒç†å¿µï¼šç±»å‹ä½“æ“è®©æˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤æ‚çš„ç±»å‹æ“ä½œï¼Œæé«˜ä»£ç çš„ç±»å‹å®‰å…¨æ€§ã€‚

### æ•°ç»„æ“ä½œç±»å‹

```typescript
// æ•°ç»„é•¿åº¦
type Length<T extends readonly any[]> = T['length']

type ArrLength = Length<[1, 2, 3, 4, 5]> // 5

// æ•°ç»„è¿æ¥
type Concat<A extends readonly any[], B extends readonly any[]> = [...A, ...B]

type ConcatResult = Concat<[1, 2], [3, 4]> // [1, 2, 3, 4]

// æ•°ç»„åè½¬
type Reverse<T extends readonly any[]> = T extends readonly [infer First, ...infer Rest]
  ? [...Reverse<Rest>, First]
  : []

type Reversed = Reverse<[1, 2, 3, 4]> // [4, 3, 2, 1]

// æ•°ç»„å»é‡
type Unique<T extends readonly any[], Result extends readonly any[] = []> = T extends readonly [
  infer First,
  ...infer Rest,
]
  ? First extends Result[number]
    ? Unique<Rest, Result>
    : Unique<Rest, [...Result, First]>
  : Result

type UniqueArray = Unique<[1, 2, 2, 3, 3, 3, 4]> // [1, 2, 3, 4]
```

### å¯¹è±¡æ“ä½œç±»å‹

```typescript
// å¯¹è±¡é”®å€¼å¯¹
type Entries<T> = {
  [K in keyof T]: [K, T[K]]
}[keyof T]

interface User {
  name: string
  age: number
  email: string
}

type UserEntries = Entries<User> // ["name", string] | ["age", number] | ["email", string]

// å¯¹è±¡å€¼ç±»å‹
type ValueOf<T> = T[keyof T]

type UserValues = ValueOf<User> // string | number

// æ·±åº¦åˆå¹¶
type DeepMerge<T, U> = {
  [K in keyof T | keyof U]: K extends keyof U
    ? K extends keyof T
      ? T[K] extends object
        ? U[K] extends object
          ? DeepMerge<T[K], U[K]>
          : U[K]
        : U[K]
      : U[K]
    : K extends keyof T
      ? T[K]
      : never
}

interface BaseConfig {
  api: {
    baseUrl: string
    timeout: number
  }
  ui: {
    theme: string
  }
}

interface OverrideConfig {
  api: {
    timeout: number
  }
  ui: {
    theme: string
    language: string
  }
}

type MergedConfig = DeepMerge<BaseConfig, OverrideConfig>
// ç»“æœï¼šæ·±åº¦åˆå¹¶ä¸¤ä¸ªé…ç½®å¯¹è±¡
```

---

## å…­ã€å·¥ç¨‹åŒ–å®è·µï¼šç±»å‹å®‰å…¨çš„é¡¹ç›®æ¶æ„

### 1. ç±»å‹å®šä¹‰ç»„ç»‡

```typescript
// types/index.ts - ç±»å‹å®šä¹‰å…¥å£
export * from './api'
export * from './user'
export * from './product'
export * from './common'

// types/api.ts - API ç›¸å…³ç±»å‹
export interface ApiResponse<T = any> {
  data: T
  status: number
  message: string
  timestamp: number
}

export interface ApiError {
  code: string
  message: string
  details?: Record<string, any>
}

export type ApiResult<T> = ApiResponse<T> | ApiError

// types/user.ts - ç”¨æˆ·ç›¸å…³ç±»å‹
export interface User {
  id: number
  name: string
  email: string
  avatar?: string
  createdAt: Date
  updatedAt: Date
}

export interface CreateUserRequest {
  name: string
  email: string
  password: string
}

export interface UpdateUserRequest {
  name?: string
  email?: string
  avatar?: string
}

// types/product.ts - äº§å“ç›¸å…³ç±»å‹
export interface Product {
  id: number
  title: string
  description: string
  price: number
  category: ProductCategory
  images: string[]
  inStock: boolean
}

export interface ProductCategory {
  id: number
  name: string
  slug: string
}

// types/common.ts - é€šç”¨ç±»å‹
export type ID = string | number

export interface PaginationParams {
  page: number
  limit: number
  sort?: string
  order?: 'asc' | 'desc'
}

export interface PaginatedResponse<T> {
  data: T[]
  pagination: {
    page: number
    limit: number
    total: number
    totalPages: number
  }
}
```

### 2. ç±»å‹å®‰å…¨çš„ API å®¢æˆ·ç«¯

```typescript
// api/client.ts
import { ApiResponse, ApiError, ApiResult } from '../types'

class ApiClient {
  private baseUrl: string
  private defaultHeaders: Record<string, string>

  constructor(baseUrl: string, defaultHeaders: Record<string, string> = {}) {
    this.baseUrl = baseUrl
    this.defaultHeaders = {
      'Content-Type': 'application/json',
      ...defaultHeaders,
    }
  }

  async request<T>(endpoint: string, options: RequestInit = {}): Promise<ApiResult<T>> {
    try {
      const response = await fetch(`${this.baseUrl}${endpoint}`, {
        ...options,
        headers: {
          ...this.defaultHeaders,
          ...options.headers,
        },
      })

      const data = await response.json()

      if (!response.ok) {
        return {
          code: data.code || 'UNKNOWN_ERROR',
          message: data.message || 'An error occurred',
          details: data.details,
        }
      }

      return {
        data: data.data || data,
        status: response.status,
        message: data.message || 'Success',
        timestamp: Date.now(),
      }
    } catch (error) {
      return {
        code: 'NETWORK_ERROR',
        message: error instanceof Error ? error.message : 'Network error',
      }
    }
  }

  // ç±»å‹å®‰å…¨çš„ GET è¯·æ±‚
  async get<T>(endpoint: string): Promise<ApiResult<T>> {
    return this.request<T>(endpoint, { method: 'GET' })
  }

  // ç±»å‹å®‰å…¨çš„ POST è¯·æ±‚
  async post<T, U = any>(endpoint: string, data: U): Promise<ApiResult<T>> {
    return this.request<T>(endpoint, {
      method: 'POST',
      body: JSON.stringify(data),
    })
  }

  // ç±»å‹å®‰å…¨çš„ PUT è¯·æ±‚
  async put<T, U = any>(endpoint: string, data: U): Promise<ApiResult<T>> {
    return this.request<T>(endpoint, {
      method: 'PUT',
      body: JSON.stringify(data),
    })
  }

  // ç±»å‹å®‰å…¨çš„ DELETE è¯·æ±‚
  async delete<T>(endpoint: string): Promise<ApiResult<T>> {
    return this.request<T>(endpoint, { method: 'DELETE' })
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const apiClient = new ApiClient('https://api.example.com')

// ç±»å‹å®‰å…¨çš„ API è°ƒç”¨
const userResult = await apiClient.get<User>('/users/1')
if ('data' in userResult) {
  console.log(userResult.data.name) // ç±»å‹å®‰å…¨
} else {
  console.error(userResult.message) // é”™è¯¯å¤„ç†
}
```

### 3. ç±»å‹å®‰å…¨çš„ç»„ä»¶ Props

```typescript
// components/Button.tsx
import React from 'react';

// æŒ‰é’®å˜ä½“ç±»å‹
type ButtonVariant = 'primary' | 'secondary' | 'danger' | 'success';
type ButtonSize = 'small' | 'medium' | 'large';

// åŸºç¡€æŒ‰é’®å±æ€§
interface BaseButtonProps {
  children: React.ReactNode;
  variant?: ButtonVariant;
  size?: ButtonSize;
  disabled?: boolean;
  loading?: boolean;
  onClick?: () => void;
}

// é“¾æ¥æŒ‰é’®å±æ€§
interface LinkButtonProps extends BaseButtonProps {
  href: string;
  target?: '_blank' | '_self' | '_parent' | '_top';
}

// æäº¤æŒ‰é’®å±æ€§
interface SubmitButtonProps extends BaseButtonProps {
  type: 'submit';
  form?: string;
}

// æŒ‰é’®å±æ€§è”åˆç±»å‹
type ButtonProps = LinkButtonProps | SubmitButtonProps | BaseButtonProps;

// ç±»å‹å®ˆå«
function isLinkButton(props: ButtonProps): props is LinkButtonProps {
  return 'href' in props;
}

function isSubmitButton(props: ButtonProps): props is SubmitButtonProps {
  return 'type' in props && props.type === 'submit';
}

// æŒ‰é’®ç»„ä»¶
export const Button: React.FC<ButtonProps> = (props) => {
  const { children, variant = 'primary', size = 'medium', disabled, loading } = props;

  const baseClasses = 'btn';
  const variantClasses = `btn--${variant}`;
  const sizeClasses = `btn--${size}`;
  const stateClasses = disabled ? 'btn--disabled' : '';
  const loadingClasses = loading ? 'btn--loading' : '';

  const className = [baseClasses, variantClasses, sizeClasses, stateClasses, loadingClasses]
    .filter(Boolean)
    .join(' ');

  if (isLinkButton(props)) {
    return (
      <a
        href={props.href}
        target={props.target}
        className={className}
        onClick={props.onClick}
      >
        {loading ? 'åŠ è½½ä¸­...' : children}
      </a>
    );
  }

  if (isSubmitButton(props)) {
    return (
      <button
        type="submit"
        form={props.form}
        className={className}
        disabled={disabled || loading}
        onClick={props.onClick}
      >
        {loading ? 'åŠ è½½ä¸­...' : children}
      </button>
    );
  }

  return (
    <button
      type="button"
      className={className}
      disabled={disabled || loading}
      onClick={props.onClick}
    >
      {loading ? 'åŠ è½½ä¸­...' : children}
    </button>
  );
};

// ä½¿ç”¨ç¤ºä¾‹
const App: React.FC = () => {
  return (
    <div>
      <Button variant="primary" size="large" onClick={() => console.log('clicked')}>
        ç‚¹å‡»æˆ‘
      </Button>

      <Button href="/about" variant="secondary">
        å…³äºæˆ‘ä»¬
      </Button>

      <Button type="submit" form="myForm" variant="success">
        æäº¤è¡¨å•
      </Button>
    </div>
  );
};
```

### 4. ç±»å‹å®‰å…¨çš„ Redux Store

```typescript
// store/types.ts
export interface RootState {
  user: UserState
  products: ProductsState
  cart: CartState
}

export interface UserState {
  currentUser: User | null
  loading: boolean
  error: string | null
}

export interface ProductsState {
  items: Product[]
  loading: boolean
  error: string | null
  filters: ProductFilters
}

export interface CartState {
  items: CartItem[]
  total: number
  loading: boolean
}

export interface CartItem {
  productId: number
  quantity: number
  price: number
}

export interface ProductFilters {
  category?: string
  minPrice?: number
  maxPrice?: number
  inStock?: boolean
}

// store/actions.ts
export const userActions = {
  setUser: (user: User) => ({ type: 'user/setUser', payload: user }),
  setLoading: (loading: boolean) => ({ type: 'user/setLoading', payload: loading }),
  setError: (error: string | null) => ({ type: 'user/setError', payload: error }),
} as const

export const productActions = {
  setProducts: (products: Product[]) => ({ type: 'products/setProducts', payload: products }),
  setFilters: (filters: ProductFilters) => ({ type: 'products/setFilters', payload: filters }),
  setLoading: (loading: boolean) => ({ type: 'products/setLoading', payload: loading }),
  setError: (error: string | null) => ({ type: 'products/setError', payload: error }),
} as const

export const cartActions = {
  addItem: (item: CartItem) => ({ type: 'cart/addItem', payload: item }),
  removeItem: (productId: number) => ({ type: 'cart/removeItem', payload: productId }),
  updateQuantity: (productId: number, quantity: number) => ({
    type: 'cart/updateQuantity',
    payload: { productId, quantity },
  }),
  clearCart: () => ({ type: 'cart/clearCart' }),
} as const

// store/reducers.ts
import { Reducer } from 'redux'

const userReducer: Reducer<UserState> = (state = initialState.user, action) => {
  switch (action.type) {
    case 'user/setUser':
      return { ...state, currentUser: action.payload }
    case 'user/setLoading':
      return { ...state, loading: action.payload }
    case 'user/setError':
      return { ...state, error: action.payload }
    default:
      return state
  }
}

const productsReducer: Reducer<ProductsState> = (state = initialState.products, action) => {
  switch (action.type) {
    case 'products/setProducts':
      return { ...state, items: action.payload }
    case 'products/setFilters':
      return { ...state, filters: { ...state.filters, ...action.payload } }
    case 'products/setLoading':
      return { ...state, loading: action.payload }
    case 'products/setError':
      return { ...state, error: action.payload }
    default:
      return state
  }
}

const cartReducer: Reducer<CartState> = (state = initialState.cart, action) => {
  switch (action.type) {
    case 'cart/addItem':
      const existingItem = state.items.find((item) => item.productId === action.payload.productId)
      if (existingItem) {
        return {
          ...state,
          items: state.items.map((item) =>
            item.productId === action.payload.productId
              ? { ...item, quantity: item.quantity + action.payload.quantity }
              : item
          ),
        }
      }
      return { ...state, items: [...state.items, action.payload] }
    case 'cart/removeItem':
      return {
        ...state,
        items: state.items.filter((item) => item.productId !== action.payload),
      }
    case 'cart/updateQuantity':
      return {
        ...state,
        items: state.items.map((item) =>
          item.productId === action.payload.productId
            ? { ...item, quantity: action.payload.quantity }
            : item
        ),
      }
    case 'cart/clearCart':
      return { ...state, items: [] }
    default:
      return state
  }
}

// store/selectors.ts
import { createSelector } from '@reduxjs/toolkit'

// åŸºç¡€é€‰æ‹©å™¨
const selectUser = (state: RootState) => state.user
const selectProducts = (state: RootState) => state.products
const selectCart = (state: RootState) => state.cart

// æ´¾ç”Ÿé€‰æ‹©å™¨
export const selectCurrentUser = createSelector(selectUser, (user) => user.currentUser)

export const selectFilteredProducts = createSelector(selectProducts, (products) => {
  const { items, filters } = products
  return items.filter((product) => {
    if (filters.category && product.category.slug !== filters.category) {
      return false
    }
    if (filters.minPrice && product.price < filters.minPrice) {
      return false
    }
    if (filters.maxPrice && product.price > filters.maxPrice) {
      return false
    }
    if (filters.inStock !== undefined && product.inStock !== filters.inStock) {
      return false
    }
    return true
  })
})

export const selectCartTotal = createSelector(selectCart, (cart) =>
  cart.items.reduce((total, item) => total + item.price * item.quantity, 0)
)

export const selectCartItemCount = createSelector(selectCart, (cart) =>
  cart.items.reduce((count, item) => count + item.quantity, 0)
)
```

---

## ä¸ƒã€ç±»å‹å®‰å…¨çš„æµ‹è¯•

```typescript
// tests/utils/test-utils.ts
import { render, RenderOptions } from '@testing-library/react';
import { ReactElement } from 'react';
import { Provider } from 'react-redux';
import { configureStore } from '@reduxjs/toolkit';
import { RootState } from '../store/types';

// åˆ›å»ºæµ‹è¯•ç”¨çš„ store
export const createTestStore = (preloadedState?: Partial<RootState>) => {
  return configureStore({
    reducer: {
      user: (state = { currentUser: null, loading: false, error: null }) => state,
      products: (state = { items: [], loading: false, error: null, filters: {} }) => state,
      cart: (state = { items: [], total: 0, loading: false }) => state
    },
    preloadedState
  });
};

// è‡ªå®šä¹‰æ¸²æŸ“å‡½æ•°
export const renderWithProviders = (
  ui: ReactElement,
  {
    preloadedState,
    store = createTestStore(preloadedState),
    ...renderOptions
  }: {
    preloadedState?: Partial<RootState>;
    store?: ReturnType<typeof createTestStore>;
  } & Omit<RenderOptions, 'wrapper'> = {}
) => {
  const Wrapper = ({ children }: { children: React.ReactNode }) => (
    <Provider store={store}>{children}</Provider>
  );

  return { store, ...render(ui, { wrapper: Wrapper, ...renderOptions }) };
};

// æµ‹è¯•è¾…åŠ©å‡½æ•°
export const createMockUser = (overrides: Partial<User> = {}): User => ({
  id: 1,
  name: 'Test User',
  email: 'test@example.com',
  avatar: 'https://example.com/avatar.jpg',
  createdAt: new Date('2023-01-01'),
  updatedAt: new Date('2023-01-01'),
  ...overrides
});

export const createMockProduct = (overrides: Partial<Product> = {}): Product => ({
  id: 1,
  title: 'Test Product',
  description: 'A test product',
  price: 99.99,
  category: { id: 1, name: 'Test Category', slug: 'test-category' },
  images: ['https://example.com/image.jpg'],
  inStock: true,
  ...overrides
});
```

---

## å…«ã€å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šç±»å‹æ–­è¨€è¿‡åº¦ä½¿ç”¨

```typescript
// é”™è¯¯åšæ³•ï¼šè¿‡åº¦ä½¿ç”¨ç±»å‹æ–­è¨€
const user = getUser() as User // å±é™©ï¼šå¯èƒ½è¿è¡Œæ—¶å‡ºé”™

// æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ç±»å‹å®ˆå«
function isUser(obj: any): obj is User {
  return obj && typeof obj.id === 'number' && typeof obj.name === 'string'
}

const userData = getUser()
if (isUser(userData)) {
  // ç°åœ¨ userData è¢«æ­£ç¡®æ¨æ–­ä¸º User ç±»å‹
  console.log(userData.name)
}
```

### é—®é¢˜2ï¼šany ç±»å‹æ»¥ç”¨

```typescript
// é”™è¯¯åšæ³•ï¼šä½¿ç”¨ any ç±»å‹
function processData(data: any): any {
  return data.someProperty
}

// æ­£ç¡®åšæ³•ï¼šä½¿ç”¨æ³›å‹æˆ–å…·ä½“ç±»å‹
function processData<T>(data: T): T {
  return data
}

// æˆ–è€…ä½¿ç”¨ unknown ç±»å‹
function processData(data: unknown): string {
  if (typeof data === 'string') {
    return data
  }
  throw new Error('Expected string')
}
```

### é—®é¢˜3ï¼šç±»å‹å®šä¹‰ä¸å®Œæ•´

```typescript
// é”™è¯¯åšæ³•ï¼šç±»å‹å®šä¹‰ä¸å®Œæ•´
interface User {
  name: string
  // ç¼ºå°‘å…¶ä»–å¿…è¦å±æ€§
}

// æ­£ç¡®åšæ³•ï¼šå®Œæ•´çš„ç±»å‹å®šä¹‰
interface User {
  id: number
  name: string
  email: string
  avatar?: string
  createdAt: Date
  updatedAt: Date
}

// æˆ–è€…ä½¿ç”¨å·¥å…·ç±»å‹
type PartialUser = Partial<User> // æ‰€æœ‰å±æ€§å¯é€‰
type RequiredUser = Required<User> // æ‰€æœ‰å±æ€§å¿…éœ€
```

---

## ç»“è¯­

TypeScript çš„é«˜çº§ç±»å‹ç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†å¼ºå¤§çš„å·¥å…·æ¥æ„å»ºç±»å‹å®‰å…¨çš„åº”ç”¨ç¨‹åºã€‚é€šè¿‡åˆç†ä½¿ç”¨æ³›å‹ã€æ¡ä»¶ç±»å‹ã€æ˜ å°„ç±»å‹ç­‰ç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š

1. **æé«˜ä»£ç è´¨é‡**ï¼šåœ¨ç¼–è¯‘æ—¶æ•è·æ›´å¤šé”™è¯¯
2. **å¢å¼ºå¼€å‘ä½“éªŒ**ï¼šæ›´å¥½çš„ IDE æ”¯æŒå’Œè‡ªåŠ¨è¡¥å…¨
3. **é™ä½ç»´æŠ¤æˆæœ¬**ï¼šç±»å‹ä½œä¸ºæ–‡æ¡£ï¼Œå‡å°‘ç†è§£æˆæœ¬
4. **æé«˜å›¢é˜Ÿåä½œæ•ˆç‡**ï¼šç»Ÿä¸€çš„ç±»å‹å®šä¹‰å’Œçº¦å®š

ä½†ä¹Ÿè¦æ³¨æ„ä¸è¦è¿‡åº¦ä½¿ç”¨å¤æ‚çš„ç±»å‹æ“ä½œï¼Œä¿æŒä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚è®°ä½ï¼š**ç±»å‹ç³»ç»Ÿæ˜¯å·¥å…·ï¼Œä¸æ˜¯ç›®çš„ï¼Œæœ€ç»ˆç›®æ ‡æ˜¯ä¸ºä¸šåŠ¡æœåŠ¡**ã€‚
